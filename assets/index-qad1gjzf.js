var Me=Object.defineProperty;var xe=(a,e,s)=>e in a?Me(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s;var j=(a,e,s)=>(xe(a,typeof e!="symbol"?e+"":e,s),s),me=(a,e,s)=>{if(!e.has(a))throw TypeError("Cannot "+s)};var t=(a,e,s)=>(me(a,e,"read from private field"),s?s.call(a):e.get(a)),r=(a,e,s)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,s)},i=(a,e,s,o)=>(me(a,e,"write to private field"),o?o.call(a,s):e.set(a,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const h of n)if(h.type==="childList")for(const l of h.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const h={};return n.integrity&&(h.integrity=n.integrity),n.referrerPolicy&&(h.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?h.credentials="include":n.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function o(n){if(n.ep)return;n.ep=!0;const h=s(n);fetch(n.href,h)}})();let be;var f,M,L,x,$t,w,mt,Mt,ft,Y,pt,yt,gt,D;class De{constructor(e,s,o,n,h,l,c,u,d,O,H,p,_,Q,Ut,_e){j(this,"zoomYLevel",.2222);j(this,"zoomXLevel",0);r(this,f,void 0);r(this,M,void 0);r(this,L,void 0);r(this,x,void 0);r(this,$t,void 0);r(this,w,void 0);r(this,mt,void 0);r(this,Mt,!1);r(this,ft,void 0);r(this,Y,!0);r(this,pt,void 0);r(this,yt,!0);r(this,gt,!0);r(this,D,!1);i(this,f,new Te(this,e,s,o,n)),i(this,M,new Le(this,h,l,c,u)),i(this,L,new Ce(this,d,O,H,p)),i(this,x,new ze(this,_,Q,Ut,_e)),document.querySelectorAll("#top-nav button").forEach(y=>{y.addEventListener("click",(function(g){const v=g.target;v.id==="tf1m"||v.id==="tf3m"||v.id==="tf5m"||v.id==="tf15m"||(v.classList.toggle("disabled"),v.id==="cvdToggleBtn"?(i(this,yt,!t(this,yt)),t(this,x).toggleIndicator("cvd",t(this,yt))):v.id==="oiToggleBtn"&&(i(this,gt,!t(this,gt)),t(this,x).toggleIndicator("oi",t(this,gt))),!t(this,yt)&&!t(this,gt)?(document.querySelector("#canvas4").style.display="none",document.querySelector("#canvas1").style.height="90%",document.querySelector("#canvas2").style.height="90%",document.querySelector("#canvas3").style.height="10%",document.querySelector("#canvas3").style.top="90%"):(document.querySelector("#canvas4").style.display="flex",document.querySelector("#canvas1").style.height="80%",document.querySelector("#canvas2").style.height="80%",document.querySelector("#canvas3").style.height="10%",document.querySelector("#canvas3").style.top="90%"))}).bind(this))}),i(this,pt,document.querySelector("#btn2")),t(this,pt).addEventListener("click",y=>{i(this,Y,!t(this,Y)),this.updateScaleBtn()});const ue=document.querySelector("#ticksize-select");ue.addEventListener("change",y=>{const g=t(this,$t)*ue.value;console.log("new tick size:",g),t(this,f).bucketSize=g,t(this,f).maxQuantity=20,t(this,M).bucketSize=g}),t(this,f).canvas.addEventListener("mousedown",y=>{i(this,Mt,!0),i(this,ft,{x:y.clientX,y:y.clientY})}),t(this,f).canvas.addEventListener("mousemove",y=>{if(t(this,Mt)){i(this,Y,!1);let g={x:y.clientX,y:y.clientY},v=g.x-t(this,ft).x,Gt=g.y-t(this,ft).y;t(this,D)||(i(this,D,!0),requestAnimationFrame(()=>{t(this,f).panXY(v,Gt),t(this,M).panY(Gt),t(this,L).panX(v),t(this,x).panX(v),t(this,f).updateData(t(this,w),[]),t(this,M).updateData(t(this,w),t(this,mt)),t(this,L).updateData(t(this,w)),t(this,x).updateData(t(this,w),[]),i(this,D,!1)})),i(this,ft,g),this.updateScaleBtn()}}),["mouseup","mouseleave"].forEach(y=>t(this,f).canvas.addEventListener(y,()=>i(this,Mt,!1))),t(this,f).canvas.addEventListener("wheel",y=>{y.preventDefault(),i(this,Y,!1);const g=5e-4/(.01-.001);let v=this.zoomYLevel-(y.deltaY>0?-g:g),Gt=this.zoomXLevel+(y.deltaY>0?-g:g);this.zoomYLevel=Math.max(0,Math.min(v,1)),this.zoomXLevel=Math.max(0,Math.min(Gt,1)),t(this,D)||(i(this,D,!0),requestAnimationFrame(()=>{t(this,f).zoomY(this.zoomYLevel),t(this,f).zoomX(this.zoomXLevel),t(this,M).zoomY(this.zoomYLevel),t(this,L).zoomX(this.zoomXLevel),t(this,x).zoomX(this.zoomXLevel),t(this,f).updateData(t(this,w),[]),t(this,M).updateData(t(this,w),t(this,mt)),t(this,L).updateData(t(this,w)),t(this,x).updateData(t(this,w),[]),i(this,D,!1)}),this.updateScaleBtn())}),t(this,M).canvas.addEventListener("wheel",y=>{y.preventDefault(),i(this,Y,!1);const g=5e-4/(.01-.001);let v=this.zoomYLevel-(y.deltaY>0?-g:g);this.zoomYLevel=Math.max(0,Math.min(v,1)),t(this,D)||(i(this,D,!0),requestAnimationFrame(()=>{t(this,f).zoomY(this.zoomYLevel),t(this,M).zoomY(this.zoomYLevel),t(this,f).updateData(t(this,w),[]),t(this,M).updateData(t(this,w),t(this,mt)),i(this,D,!1)}),this.updateScaleBtn())}),t(this,L).canvas.addEventListener("wheel",y=>{y.preventDefault(),i(this,Y,!1);const g=5e-4/(.01-.001);let v=this.zoomXLevel+(y.deltaY>0?-g:g);this.zoomXLevel=Math.max(0,Math.min(v,1)),t(this,D)||(i(this,D,!0),requestAnimationFrame(()=>{t(this,f).zoomX(this.zoomXLevel),t(this,L).zoomX(this.zoomXLevel),t(this,x).zoomX(this.zoomXLevel),t(this,f).updateData(t(this,w),[]),t(this,L).updateData(t(this,w)),t(this,x).updateData(t(this,w),[]),i(this,D,!1)})),this.updateScaleBtn()})}updateScaleBtn(){t(this,Y)?(t(this,f).resetZoomAndPan(),t(this,M).resetZoomAndPan(),t(this,L).resetZoomAndPan(),t(this,x).resetZoomAndPan(),t(this,pt).innerHTML='<svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 448 512"><path fill="#c8c8c8" d="M144 144v48H304V144c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64H80z"/></svg>'):t(this,pt).innerHTML='<svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 576 512"><path fill="#c8c8c8" d="M352 144c0-44.2 35.8-80 80-80s80 35.8 80 80v48c0 17.7 14.3 32 32 32s32-14.3 32-32V144C576 64.5 511.5 0 432 0S288 64.5 288 144v48H64c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V256c0-35.3-28.7-64-64-64H352V144z"/></svg>'}updateData(e){i(this,w,e.kline),i(this,mt,e.depth),t(this,f).updateData(e.kline,e.tradesBuffer),t(this,M).updateData(e.kline,e.depth),t(this,L).updateData(e.kline),t(this,x).updateData(e.kline,e.tradesBuffer)}startNew(e,s){i(this,Y,!0),this.updateScaleBtn(),t(this,f).resetData(),t(this,M).resetData(),t(this,L).resetData(),t(this,x).resetData(),this.zoomYLevel=.2222,this.zoomXLevel=0,be=e,i(this,$t,s)}}f=new WeakMap,M=new WeakMap,L=new WeakMap,x=new WeakMap,$t=new WeakMap,w=new WeakMap,mt=new WeakMap,Mt=new WeakMap,ft=new WeakMap,Y=new WeakMap,pt=new WeakMap,yt=new WeakMap,gt=new WeakMap,D=new WeakMap;var te,m,$,A,st,bt,it,ht,xt,B,vt,Dt,S,Tt,Lt,ot,Ct,N,rt;class Te{constructor(e,s,o,n,h){r(this,te,void 0);r(this,m,void 0);r(this,$,void 0);r(this,A,void 0);r(this,st,[]);r(this,bt,[]);r(this,it,void 0);r(this,ht,[]);r(this,xt,void 0);r(this,B,void 0);r(this,vt,void 0);r(this,Dt,60);r(this,S,void 0);r(this,Tt,.997);r(this,Lt,1.003);r(this,ot,30);j(this,"bucketSize");r(this,Ct,!0);r(this,N,0);r(this,rt,0);i(this,te,e),i(this,m,s),this.canvas=o,i(this,$,n),i(this,A,h),i(this,S,Math.round(1*60*1e3/(30*60*1e3)*(t(this,$)-t(this,Dt)))),this.tradesDrawType=0,this.maxQuantity=20}panXY(e,s){i(this,Ct,!1);const o=t(this,A)/(t(this,vt)-t(this,B)),n=s/o;i(this,rt,t(this,rt)+n),i(this,N,t(this,N)+e<0?0:t(this,N)+e)}zoomY(e){const l=.001+.009000000000000001*e,c=.001+(.01-.001)*e;i(this,Tt,Math.round((1-l)*1e4)/1e4),i(this,Lt,Math.round((1+c)*1e4)/1e4)}zoomX(e){i(this,ot,30+-20*e),i(this,S,Math.round(1*60*1e3/(t(this,ot)*60*1e3)*(t(this,$)-t(this,Dt))))}resetZoomAndPan(){i(this,Ct,!0),i(this,N,0),i(this,rt,0),i(this,Tt,.997),i(this,Lt,1.003),i(this,ot,30),i(this,S,Math.round(1*60*1e3/(t(this,ot)*60*1e3)*(t(this,$)-t(this,Dt))))}resetData(){i(this,st,[]),i(this,bt,[]),i(this,it,null),i(this,ht,[]),i(this,xt,null),i(this,B,null),i(this,vt,null),i(this,Ct,!0),i(this,N,0),i(this,rt,0)}updateData(e,s){const{k:{t:o,T:n,o:h,h:l,l:c,c:u}}=e;i(this,B,Math.min((Number(l)+Number(c))/2*t(this,Tt),c)+t(this,rt)),i(this,vt,Math.max((Number(l)+Number(c))/2*t(this,Lt),l)+t(this,rt)),t(this,xt)!==h&&(t(this,it)&&(t(this,st).push(t(this,it)),t(this,bt).push(t(this,ht)),t(this,st).length>60&&(t(this,st).shift(),t(this,bt).shift()),i(this,ht,[])),i(this,xt,h)),i(this,it,{startTime:o,endTime:n,openPrice:h,highPrice:l,lowPrice:c,closePrice:u}),t(this,ht).push(s),this.drawStart()}drawStart(){if(t(this,m).clearRect(0,0,t(this,$),t(this,A)),t(this,st).length>0){const e=t(this,it).startTime-t(this,ot)*60*1e3+t(this,N);t(this,st).forEach((s,o)=>{const n=t(this,bt)[o],h=Math.round((s.startTime-e)/(t(this,ot)*60*1e3)*(t(this,$)-t(this,S)));this.drawDataPoint(n,s,h+t(this,N))})}this.drawDataPoint(t(this,ht),t(this,it),Math.round(t(this,$)-t(this,S))+t(this,N))}drawDataPoint(e,s,o){const n=t(this,A)/(t(this,vt)-t(this,B)),h=Math.round(t(this,A)-(s.openPrice-t(this,B))*n),l=Math.round(t(this,A)-(s.highPrice-t(this,B))*n),c=Math.round(t(this,A)-(s.lowPrice-t(this,B))*n),u=Math.round(t(this,A)-(s.closePrice-t(this,B))*n);this.drawKlineAt(o,l-2),this.drawKlineAt(o,c+2);const O=[].concat(...e).reduce((p,_)=>{const Q=Math.round(_.y/this.bucketSize)*this.bucketSize,Ut=`${Q}-${_.m}`;return p[Ut]||(p[Ut]={..._,y:Q,q:0}),p[Ut].q+=_.q,p},{}),H=Math.max(...Object.values(O).map(p=>p.q));this.maxQuantity=H>this.maxQuantity?H:this.maxQuantity,Object.values(O).forEach(p=>{const _=Math.round(t(this,A)-(p.y-t(this,B))*n),Q=this.scaleQuantity(p.q);this.drawTradesAt(o,_,p.m,Q)}),t(this,m).beginPath(),t(this,m).moveTo(o+t(this,S)/2,h),t(this,m).lineTo(o+t(this,S)/2,u),t(this,m).strokeStyle=u<h?"#9BE6D1":"#E6A1A0",t(this,m).stroke()}drawKlineAt(e,s){t(this,m).beginPath(),t(this,m).moveTo(e+5,s),t(this,m).lineTo(e+t(this,S)-5,s),t(this,m).strokeStyle="rgba(200, 200, 200, 0.5)",t(this,m).stroke()}drawTradesAt(e,s,o,n){t(this,m).beginPath(),o?(t(this,m).moveTo(e-4+t(this,S)/2,s),t(this,m).lineTo(e-4+t(this,S)/2-n,s),t(this,m).strokeStyle="rgba(192, 80, 77, 1)"):(t(this,m).moveTo(e+4+t(this,S)/2,s),t(this,m).lineTo(e+4+t(this,S)/2+n,s),t(this,m).strokeStyle="rgba(81, 205, 160, 1)"),t(this,m).stroke()}scaleQuantity(e){const n=t(this,S)/2-4;return 0+(e-.001)*(n-0)/(this.maxQuantity-.001)}}te=new WeakMap,m=new WeakMap,$=new WeakMap,A=new WeakMap,st=new WeakMap,bt=new WeakMap,it=new WeakMap,ht=new WeakMap,xt=new WeakMap,B=new WeakMap,vt=new WeakMap,Dt=new WeakMap,S=new WeakMap,Tt=new WeakMap,Lt=new WeakMap,ot=new WeakMap,Ct=new WeakMap,N=new WeakMap,rt=new WeakMap;var ee,k,wt,q,zt,nt,V,lt,Et,Pt,It,kt;class Le{constructor(e,s,o,n,h){r(this,ee,void 0);r(this,k,void 0);r(this,wt,void 0);r(this,q,void 0);r(this,zt,void 0);r(this,nt,void 0);r(this,V,void 0);r(this,lt,void 0);r(this,Et,.997);r(this,Pt,1.003);j(this,"bucketSize");r(this,It,!0);r(this,kt,0);i(this,ee,e),i(this,k,s),this.canvas=o,i(this,wt,n),i(this,q,h),this.maxQuantity=20}panY(e){i(this,It,!1);const s=t(this,q)/(t(this,lt)-t(this,V)),o=e/s;i(this,kt,t(this,kt)+o)}zoomY(e){const l=.001+.009000000000000001*e,c=.001+(.01-.001)*e;i(this,Et,Math.round((1-l)*1e4)/1e4),i(this,Pt,Math.round((1+c)*1e4)/1e4)}resetZoomAndPan(){i(this,It,!0),i(this,Et,.997),i(this,Pt,1.003),i(this,kt,0)}resetData(){i(this,zt,null),i(this,nt,null),i(this,V,null),i(this,lt,null),i(this,It,!0)}updateData(e,s){const{k:{o,h:n,l:h,c:l}}=e;i(this,zt,{openPrice:o,highPrice:n,lowPrice:h,closePrice:l});const{asks:c,bids:u}=s;i(this,nt,{asks:c,bids:u}),i(this,V,Math.min((Number(n)+Number(h))/2*t(this,Et),h)+t(this,kt)),i(this,lt,Math.max((Number(n)+Number(h))/2*t(this,Pt),n)+t(this,kt)),this.drawStart()}drawStart(){t(this,k).clearRect(0,0,t(this,wt),t(this,q));const e=t(this,q)/(t(this,lt)-t(this,V)),{closePrice:s,openPrice:o}=t(this,zt),n=Math.round(t(this,q)-(s-t(this,V))*e),h=Math.round(t(this,q)-(o-t(this,V))*e),l=n>h?"#C0504E":n<h?"#51CDA0":"#c8c8c8";if(this.drawTextAt(n,s,l),this.drawTextAt(t(this,q)-10,Math.round(t(this,V)),"#c8c8c8"),this.drawTextAt(15,Math.round(t(this,lt)),"#c8c8c8"),this.maxQuantity=20,t(this,nt).asks&&t(this,nt).bids){const c=H=>H.reduce((p,_)=>{const Q=Math.round(_[0]/this.bucketSize)*this.bucketSize;return p[Q]||(p[Q]=0),p[Q]+=parseFloat(_[1]),p},{}),u=c(t(this,nt).asks),d=c(t(this,nt).bids),O=[...Object.values(u),...Object.values(d)];this.maxQuantity=Math.max.apply(null,O),Object.entries(u).forEach(([H,p])=>{const _=Math.round(t(this,q)-(H-t(this,V))*e);this.drawLineAt(_,"#C0504E",p)}),Object.entries(d).forEach(([H,p])=>{const _=Math.round(t(this,q)-(H-t(this,V))*e);this.drawLineAt(_,"#51CDA0",p)})}t(this,k).font="10px monospace",t(this,k).fillStyle="#c8c8c8",t(this,k).fillText(Math.round(this.maxQuantity),t(this,wt)-40,40)}drawLineAt(e,s,o){const n=o/this.maxQuantity*(t(this,wt)-80);t(this,k).beginPath(),t(this,k).moveTo(80,e),t(this,k).lineTo(n+80,e),t(this,k).strokeStyle=s,t(this,k).lineWidth=1,t(this,k).stroke()}drawTextAt(e,s,o){t(this,k).font="12px monospace",t(this,k).fillStyle=o,t(this,k).fillText(s,10,e)}}ee=new WeakMap,k=new WeakMap,wt=new WeakMap,q=new WeakMap,zt=new WeakMap,nt=new WeakMap,V=new WeakMap,lt=new WeakMap,Et=new WeakMap,Pt=new WeakMap,It=new WeakMap,kt=new WeakMap;var se,b,R,C,K,at,Ot,At,Bt,E,G,F;class Ce{constructor(e,s,o,n,h){r(this,se,void 0);r(this,b,void 0);r(this,R,void 0);r(this,C,void 0);r(this,K,[]);r(this,at,void 0);r(this,Ot,void 0);r(this,At,void 0);r(this,Bt,60);r(this,E,void 0);r(this,G,30);r(this,F,0);i(this,se,e),i(this,b,s),this.canvas=o,i(this,R,n),i(this,C,h),i(this,E,Math.round(1*60*1e3/(t(this,G)*60*1e3)*(t(this,R)-t(this,Bt))))}panX(e){i(this,F,t(this,F)+e<0?0:t(this,F)+e)}zoomX(e){i(this,G,30+-20*e),i(this,E,Math.round(1*60*1e3/(t(this,G)*60*1e3)*(t(this,R)-t(this,Bt))))}resetZoomAndPan(){i(this,F,0),i(this,G,30),i(this,E,Math.round(1*60*1e3/(t(this,G)*60*1e3)*(t(this,R)-t(this,Bt))))}resetData(){i(this,K,[]),i(this,at,null),i(this,Ot,null),i(this,At,null),i(this,F,0)}updateData(e){const{k:{t:s,T:o,v:n,V:h}}=e,l=n-h;i(this,At,Math.round(t(this,K).reduce((c,u)=>Math.max(c,u.buyVolume,u.sellVolume),Math.max(h,l)))),t(this,Ot)!==s&&(t(this,at)&&(t(this,K).push(t(this,at)),t(this,K).length>60&&t(this,K).shift()),i(this,Ot,s)),i(this,at,{startTime:s,endTime:o,buyVolume:h,sellVolume:l}),this.drawStart()}drawStart(){if(t(this,b).clearRect(0,0,t(this,R),t(this,C)),t(this,K).length>0){const e=t(this,at).startTime-t(this,G)*60*1e3+t(this,F);t(this,K).forEach((s,o)=>{const n=Math.round((s.startTime-e)/(t(this,G)*60*1e3)*(t(this,R)-t(this,E)));this.drawDataPoint(s,n+t(this,F))})}this.drawDataPoint(t(this,at),Math.round(t(this,R)-t(this,E))+t(this,F))}drawDataPoint(e,s){const o=(t(this,C)-20)/t(this,At),n=Math.max(0,Math.min(t(this,C)-20,Math.round(t(this,C)-20-e.buyVolume*o))),h=Math.max(0,Math.min(t(this,C)-20,Math.round(t(this,C)-20-e.sellVolume*o)));t(this,b).beginPath(),t(this,b).moveTo(s,0),t(this,b).lineTo(s,t(this,C)-20),t(this,b).strokeStyle="rgba(200, 200, 200, 0.4)",t(this,b).lineWidth=1,t(this,b).stroke(),this.drawTimeLabel(s,e.startTime),this.drawKlineAt(s+t(this,E)/2+t(this,E)/8,n,"#51CDA0"),this.drawKlineAt(s+t(this,E)/2-t(this,E)/8,h,"#C0504E")}drawKlineAt(e,s,o){t(this,b).beginPath(),t(this,b).moveTo(e,t(this,C)-20),t(this,b).lineTo(e,s),t(this,b).strokeStyle=o,t(this,b).lineWidth=t(this,E)/6,t(this,b).stroke()}drawTimeLabel(e,s){const o=new Date(s),n=o.getHours().toString().padStart(2,"0")+":"+o.getMinutes().toString().padStart(2,"0");t(this,b).font=t(this,C)*.1+"px monospace",t(this,b).fillStyle="#c8c8c8",t(this,b).fillText(n,e,t(this,C)-5)}}se=new WeakMap,b=new WeakMap,R=new WeakMap,C=new WeakMap,K=new WeakMap,at=new WeakMap,Ot=new WeakMap,At=new WeakMap,Bt=new WeakMap,E=new WeakMap,G=new WeakMap,F=new WeakMap;var ie,T,J,X,z,U,le,W,qt,Vt,St,Xt,tt,Zt,Z,et,P,Yt,Nt,_t,Rt,ct;class ze{constructor(e,s,o,n,h){r(this,ie,void 0);r(this,T,void 0);r(this,J,void 0);r(this,X,void 0);r(this,z,[]);r(this,U,void 0);r(this,le,void 0);r(this,W,[]);r(this,qt,void 0);r(this,Vt,void 0);r(this,St,void 0);r(this,Xt,void 0);r(this,tt,void 0);r(this,Zt,60);r(this,Z,void 0);r(this,et,30);r(this,P,0);r(this,Yt,0);r(this,Nt,!0);r(this,_t,!0);r(this,Rt,void 0);r(this,ct,void 0);i(this,ie,e),i(this,T,s),this.canvas=o,i(this,J,n),i(this,X,h),i(this,Z,Math.round(1*60*1e3/(t(this,et)*60*1e3)*(t(this,J)-t(this,Zt))))}panX(e){i(this,P,t(this,P)+e<0?0:t(this,P)+e)}zoomX(e){i(this,et,30+-20*e),i(this,Z,Math.round(1*60*1e3/(t(this,et)*60*1e3)*(t(this,J)-t(this,Zt))))}resetZoomAndPan(){i(this,P,0),i(this,et,30),i(this,Z,Math.round(1*60*1e3/(t(this,et)*60*1e3)*(t(this,J)-t(this,Zt))))}resetData(){i(this,z,[]),i(this,W,[]),i(this,U,null),i(this,qt,null),i(this,Vt,null),i(this,St,null),i(this,Xt,null),i(this,tt,null),i(this,Yt,0),i(this,P,0)}toggleIndicator(e,s){e==="oi"?i(this,Nt,s):e==="cvd"&&i(this,_t,s)}async updateData(e,s){const{k:{t:o,T:n}}=e;if(i(this,Yt,t(this,Yt)+s.reduce((h,l)=>l.m?h-l.q:h+l.q,0)),t(this,qt)!==o&&(t(this,U)&&(this.fetchOI(be).then(h=>{t(this,W).push(h)}),t(this,z).push(t(this,U)),t(this,z).length>60&&(t(this,z).shift(),t(this,W).shift())),i(this,qt,o)),i(this,U,{startTime:o,endTime:n,cumVolumeDelta:t(this,Yt)}),t(this,Nt)||t(this,_t)){i(this,Vt,t(this,W).length>0?Math.max(...t(this,W).map(Number))*1.001:0),i(this,St,t(this,W).length>0?Math.min(...t(this,W).map(Number))*.999:0);const h=t(this,z).map(l=>l.cumVolumeDelta);i(this,Xt,(Math.max(...h,t(this,U).cumVolumeDelta)||0)*1.001),i(this,tt,(Math.min(...h,t(this,U).cumVolumeDelta)||0)*.999),i(this,Rt,t(this,X)/(t(this,Vt)-t(this,St))),i(this,ct,t(this,X)/(t(this,Xt)-t(this,tt))),this.drawStart()}}drawStart(){if(t(this,T).clearRect(0,0,t(this,J),t(this,X)),t(this,z).length>0){const e=t(this,U).startTime-t(this,et)*60*1e3+t(this,P);t(this,z).forEach((s,o)=>{const n=Math.round((s.startTime-e)/(t(this,et)*60*1e3)*(t(this,J)-t(this,Z)));if(t(this,Nt)){const h=t(this,X)-(t(this,W)[o]-t(this,St))*t(this,Rt);this.drawOIPoint(n+t(this,P),h)}if(t(this,_t)){const h=t(this,X)-(s.cumVolumeDelta-t(this,tt))*t(this,ct);if(o>0){const l=t(this,X)-(t(this,z)[o-1].cumVolumeDelta-t(this,tt))*t(this,ct);this.drawCVDLine(n+t(this,P),l,n+t(this,Z)+t(this,P),h)}}})}if(t(this,_t)){const e=t(this,X)-(t(this,U).cumVolumeDelta-t(this,tt))*t(this,ct),s=Math.round(t(this,J)-t(this,Z))+t(this,P);if(t(this,z).length>0){const o=t(this,X)-(t(this,z)[t(this,z).length-1].cumVolumeDelta-t(this,tt))*t(this,ct);this.drawCVDLine(s,o,s+t(this,Z),e)}else this.drawCVDLine(s,0,s+t(this,Z),e)}}drawCVDLine(e,s,o,n){t(this,T).beginPath(),t(this,T).moveTo(e,s),t(this,T).lineTo(o,n),t(this,T).lineWidth=2,t(this,T).strokeStyle="rgba(238, 216, 139, 0.3)",t(this,T).stroke()}drawOIPoint(e,s){t(this,T).beginPath(),t(this,T).arc(e+t(this,Z),s,2,0,2*Math.PI),t(this,T).fillStyle="#c8c8c8",t(this,T).fill()}async fetchOI(e){return(await(await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${e}`)).json()).openInterest}}ie=new WeakMap,T=new WeakMap,J=new WeakMap,X=new WeakMap,z=new WeakMap,U=new WeakMap,le=new WeakMap,W=new WeakMap,qt=new WeakMap,Vt=new WeakMap,St=new WeakMap,Xt=new WeakMap,tt=new WeakMap,Zt=new WeakMap,Z=new WeakMap,et=new WeakMap,P=new WeakMap,Yt=new WeakMap,Nt=new WeakMap,_t=new WeakMap,Rt=new WeakMap,ct=new WeakMap;async function ve(){let e=Date.now()-25*60*60*1e3,s=e+60*60*1e3,o={};const[n,h]=await Promise.all([Ie(),Oe()]),l=Object.keys(n).filter(d=>!["BTCSTUSDT","CVCUSDT","DOGEUSDC","COCOSUSDT","BNBBTC","ETHBTC","RAYUSDT","HNTUSDT","SCUSDT","WIFUSDT","BTSUSDT","TOMOUSDT","FTTUSDT","SRMUSDT"].includes(d)&&!d.includes("_")),c=l.map(d=>Ee(d,e,s)),u=await Promise.all(c);return l.forEach((d,O)=>{h.hasOwnProperty(d)&&(o[d]={...n[d],...h[d],...u[O]})}),o}async function Ee(a,e,s){let o;try{o=await Pe(a);const h=await(await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${a}&period=30m&limit=1&startTime=${e}&endTime=${s}`)).json(),l=Math.round(h[0].sumOpenInterest),c=Math.round((o-l)/l*1e4)/100;return{open_interest:o,OI_24hrChange:c}}catch{return{open_interest:o,OI_24hrChange:NaN}}}async function Pe(a){try{const s=await(await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${a}`)).json();return Number(s.openInterest)}catch(e){return console.log(e,a),NaN}}async function Ie(){let a={};const s=await(await fetch("https://fapi.binance.com/fapi/v1/premiumIndex")).json();for(let o of s){let n=o.symbol,h=parseFloat(o.lastFundingRate)*100,l=parseFloat(o.markPrice);a[n]={funding_rate:parseFloat(h.toFixed(3)),mark_price:Math.round(l*1e4)/1e4}}return a}async function Oe(){let a={};const s=await(await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")).json();for(let o of s){let n=o.symbol,h=o.quoteVolume,l=o.priceChangePercent;a[n]={change:Number(l),volume:Math.round(h)}}return a}var dt,ut,Kt,I,Ft;class Ae{constructor(){r(this,dt,void 0);r(this,ut,[]);r(this,Kt,[]);r(this,I,void 0);r(this,Ft,!0);j(this,"last_update_id");j(this,"order_book");console.log("Initializing WebSocketService")}createWebSocket(e,s){t(this,dt)&&t(this,dt).readyState===1&&(console.log("Closing existing websocket connection for symbol:",t(this,I).toUpperCase()),this.order_book.shouldRefresh=!1,t(this,dt).close(),i(this,Ft,!0),this.order_book=null,i(this,ut,[])),console.log("Creating websocket connection for symbol:",e),i(this,I,e.toLowerCase()),re(t(this,I)).then(o=>{i(this,dt,new WebSocket(`wss://fstream.binance.com/stream?streams=${t(this,I)}@aggTrade/${t(this,I)}@depth@100ms/${t(this,I)}@kline_1m`)),this.setupEventListeners(t(this,dt),s),this.last_update_id=o.lastUpdateId,this.order_book=new Be(t(this,I),o.bids,o.asks)}).catch(o=>{console.error("Error initializing the order book:",o)})}setupEventListeners(e,s){e.addEventListener("open",()=>{this.order_book.refresh_order_book(t(this,I)),console.log("New WebSocket connection opened")}),e.addEventListener("close",()=>{console.log("Previous WebSocket connection was closed")});let o=!1;e.addEventListener("message",async n=>{let h=JSON.parse(n.data);if(h.stream.endsWith("@aggTrade")){let l=h.data;t(this,ut).push({x:l.T,y:parseFloat(l.p),q:parseFloat(l.q),m:l.m})}else if(h.stream.endsWith("@depth@100ms")){if(o){console.log("isHandlingDepth:",o);return}o=!0,await this.handleDepth(h.data),o=!1}else h.stream.endsWith("@kline_1m")&&(i(this,Kt,h.data),s({kline:t(this,Kt),depth:this.order_book.order_book,tradesBuffer:t(this,ut)}),i(this,ut,[]))})}async handleDepth(e){let s=e.u,o=e.U,n=e.pu;if(s<this.last_update_id){console.log("finalUpdateId < last_update_id",s,this.last_update_id);return}if(t(this,Ft))if(o<=this.last_update_id&&this.last_update_id<=s)console.log("First processed event succeeded"),i(this,Ft,!1);else{await this.reinitializeOrderBook(t(this,I));return}else if(n!=this.last_update_id){await this.reinitializeOrderBook(t(this,I));return}await this.order_book.update_order_book(e.b,e.a),this.last_update_id=s}async reinitializeOrderBook(e){console.log("Out of sync, reinitializing order book...");const s=await re(e);this.last_update_id=s.lastUpdateId,this.order_book.order_book=this.order_book.initialize_order_book(s.bids,s.asks),i(this,ut,[])}}dt=new WeakMap,ut=new WeakMap,Kt=new WeakMap,I=new WeakMap,Ft=new WeakMap;class Be{constructor(e,s,o){j(this,"currentSymbol");j(this,"order_book");j(this,"shouldRefresh",!0);console.log("initializing new OrderBook class"),this.currentSymbol=e,this.order_book=this.initialize_order_book(s,o)}initialize_order_book(e,s){let o=e.map(h=>h.map(Number)),n=s.map(h=>h.map(Number));return{bids:o,asks:n}}async refresh_order_book(e){let s=new AbortController,o=setInterval(async()=>{if(!this.shouldRefresh||e!==this.currentSymbol)clearInterval(o),s.abort();else{s=new AbortController;try{let n=await re(e,{signal:s.signal});this.order_book=this.initialize_order_book(n.bids,n.asks)}catch(n){n.name==="AbortError"?console.log("Fetch operation aborted"):console.error("Error fetching order book:",n)}}},6e3)}async update_order_book(e,s){let o=e.map(h=>h.map(Number)),n=s.map(h=>h.map(Number));[this.order_book.bids,this.order_book.asks]=await this.prepare_order_book(this.order_book.bids,this.order_book.asks,o,n)}async prepare_order_book(e,s,o,n){try{const h=new Map([...e,...o].filter(d=>d[0]>=e[e.length-1][0])),l=new Map([...s,...n].filter(d=>d[0]<=s[s.length-1][0]));let c=Array.from(h.entries()).filter(d=>d[1]!==0).sort((d,O)=>O[0]-d[0]),u=Array.from(l.entries()).filter(d=>d[1]!==0).sort((d,O)=>d[0]-O[0]);return c[0][0]>=u[0][0]&&(c=c.filter(d=>d[0]<o[o.length-1][0]),u=u.filter(d=>d[0]>n[0][0]),console.log("Error: bids[0] >= asks[0], rehandled to: ",c[0][0],u[0][0])),[c,u]}catch(h){return console.error("Error preparing order book:",h),[o,n]}}}async function re(a){return await(await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${a}&limit=500`)).json()}const ne=["btn1","btn2","btn3","btn4"],qe=["tickers-menu","menu2","menu3","settings-menu"],Ve=[ke,Ne,Ye,Fe];for(let a=0;a<ne.length;a++){const e=document.getElementById(ne[a]);e.addEventListener("click",Ve[a]),e.addEventListener("click",function(){de(ne[a],qe[a])})}const fe=document.getElementById("tickers-menu"),pe=document.getElementById("settings-menu");let ce=document.getElementById("ticker-search"),Jt;ce.addEventListener("keyup",function(){Jt=this.value.toLowerCase();let a=document.querySelectorAll("#ticker-table tbody tr");for(let e of a)e.cells[0].textContent.toLowerCase().includes(Jt)?e.style.display="":e.style.display="none"});function Xe(a){$e(a),console.log("canvas was started with symbol: "+a),ce.value="",Jt="";let e=document.querySelectorAll("#ticker-table tbody tr");for(let s of e)s.style.display="";ke()}function Ze(){const a=new Date,e=a.getHours().toString().padStart(2,"0"),s=a.getMinutes().toString().padStart(2,"0"),o=a.getSeconds().toString().padStart(2,"0");return e+":"+s+":"+o}function we(){const a=document.getElementById("tickers-update-info");a.textContent="Last updated at "+Ze()}window.onload=function(){ve().then(a=>{Se(a),we()})};function ke(){ce.value="",Jt="";let a=document.querySelectorAll("#ticker-table tbody tr");for(let e of a)e.style.display="";fe.style.display=fe.style.display==="none"?"block":"none",de("btn1","tickers-menu")}function Ye(){console.log("show menu")}function Ne(){}function Fe(){pe.style.display=pe.style.display==="none"?"block":"none",de("btn4","settings-menu")}function de(a,e){const s=document.getElementById(e),o=document.getElementById(a);(a==="btn1"||a==="btn4")&&(s.style.display==="block"?o.classList.add("active"):o.classList.remove("active"))}const ae=document.getElementById("tickers-update-btn");ae.addEventListener("click",function(){ae.disabled=!0,ve().then(a=>{Se(a),we(),ae.disabled=!1})});function ye(a){return a>=1e9?(a/1e9).toFixed(2)+"b":a>=1e6?(a/1e6).toFixed(2)+"m":a>=1e3?(a/1e3).toFixed(2)+"k":a}function he(a,e,s){let o;return e==="mark_price"?a>10?o=Math.round(a*100)/100:o=Math.round(a*1e4)/1e4:e==="volume"?(o=ye(a),o="$"+o):e==="open_interest"&&(o=ye(a*s),o="$"+o),o}function Se(a){let e=document.querySelector("#tickers-menu table tbody");e.innerHTML="";let s=Object.entries(a);s.sort(([,o],[,n])=>n.volume-o.volume);for(let o=0;o<s.length;o++){let[n,h]=s[o],l;o<e.rows.length?l=e.rows[o]:(l=e.insertRow(),l.insertCell(),l.insertCell(),l.insertCell(),l.insertCell(),l.insertCell(),l.insertCell(),l.insertCell()),l.classList.add("table-row"),l.cells[0].textContent=n,l.cells[1].textContent=he(h.mark_price,"mark_price",h.mark_price),l.cells[2].textContent=(Math.round(h.change*100)/100).toFixed(2)+"%",l.cells[3].textContent=h.funding_rate+"%",l.cells[4].textContent=he(h.open_interest,"open_interest",h.mark_price),l.cells[5].textContent=h.OI_24hrChange+"%",l.cells[6].textContent=he(h.volume,"volume",h.mark_price);const c=Math.min(Math.abs(h.change/100),1),u=Math.max(Math.abs(h.funding_rate*50),.2);h.change<0?l.style.backgroundColor="rgba(192, 80, 78, "+c*1.5+")":l.style.backgroundColor="rgba(81, 205, 160, "+c+")",h.funding_rate>0?l.cells[3].style.color="rgba(212, 80, 78, "+u*1.5+")":l.cells[3].style.color="rgba(81, 246, 160, "+u*1.5+")",l.addEventListener("click",function(){Xe(n)})}}function oe(a){const e=a.clientWidth,s=a.clientHeight;(a.width!==e||a.height!==s)&&(a.width=e,a.height=s)}let Wt=document.querySelector("#canvas1");oe(Wt);let Ue=Wt.getContext("2d"),Ht=document.querySelector("#canvas2");oe(Ht);let We=Ht.getContext("2d"),Qt=document.querySelector("#canvas3");oe(Qt);let He=Qt.getContext("2d"),jt=document.querySelector("#canvas4");oe(jt);let Qe=jt.getContext("2d");const je=new Ae,ge=new De(Ue,Wt,Wt.width,Wt.height,We,Ht,Ht.width,Ht.height,He,Qt,Qt.width,Qt.height,Qe,jt,jt.width,jt.height);function $e(a){document.querySelector("#tickerInfo-name").textContent="...",Re(a).then(e=>{je.createWebSocket(a,s=>ge.updateData(s)),ge.startNew(a,e),document.querySelector("#ticksize-select").dispatchEvent(new Event("change")),document.querySelector("#tickerInfo-name").textContent=a})}async function Re(a){let o=(await(await fetch("https://fapi.binance.com/fapi/v1/exchangeInfo")).json()).symbols.find(n=>n.symbol===a);return o?o.filters[0].tickSize:null}
